

puzzle ="""......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^...^.^...................................................................
.............................................................................................................................................
..................................................................^.^.^...^..................................................................
.............................................................................................................................................
.................................................................^...^.^.^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^.^.^.^................................................................
.............................................................................................................................................
...............................................................^.^.^...^.^...^...............................................................
.............................................................................................................................................
..............................................................^.^.^...^.^.^...^..............................................................
.............................................................................................................................................
.............................................................^.^.^.....^.^.^.^.^.............................................................
.............................................................................................................................................
............................................................^.^.^.^...^.^.....^.^............................................................
.............................................................................................................................................
...........................................................^.^.......^...^.^.^.^.^...........................................................
.............................................................................................................................................
..........................................................^.^...^.^.^...^.^.^.^.^.^..........................................................
.............................................................................................................................................
.........................................................^.^.^...^.^.^.^.^.^.^.^.^.^.........................................................
.............................................................................................................................................
........................................................^.^.^.^.........^.^...^...^.^........................................................
.............................................................................................................................................
.......................................................^.^.^...^.^.....^.^.^.......^.^.......................................................
.............................................................................................................................................
......................................................^.^.....^.^.^.....^.^.^.....^.^.^......................................................
.............................................................................................................................................
.....................................................^...^.^.^.^.^.^.....^.^.^.^.^.^.^.^.....................................................
.............................................................................................................................................
....................................................^.^...^...^.^.^.^.^.^.^.....^.^.....^....................................................
.............................................................................................................................................
...................................................^.^...^.^.^.^...^...^.....^.^...^.....^...................................................
.............................................................................................................................................
..................................................^.......^.^...^.^.^.^.^.^.....^.^...^...^..................................................
.............................................................................................................................................
.................................................^...^.....^...^...^...^.^.^.^...^.^.^.^...^.................................................
.............................................................................................................................................
................................................^.^.^.^.^...^.....^...^.^.^.^.^.^.^...^.^.^.^................................................
.............................................................................................................................................
...............................................^.^.^.^.......^...^...^.^.^...^.^.^.^.^...^.^.^...............................................
.............................................................................................................................................
..............................................^.^.^...^.^.^.^.^...^.^.....^.^.^.^.^.....^.^.^.^..............................................
.............................................................................................................................................
.............................................^.^.^.^.^.^.^...^.^.....^.^.^.^.^...^.....^...^.^.^.............................................
.............................................................................................................................................
............................................^.^.^.^.^.^.^...^.^.^...^.............^.....^.....^.^............................................
.............................................................................................................................................
...........................................^.^.^.....^...^.^.^.^...^.^...^.....^...^.....^.^.^.^.^...........................................
.............................................................................................................................................
..........................................^.^.^.^.^.^.^.^.^...^.^...^.^.......^.^.....^.^.^...^.^.^..........................................
.............................................................................................................................................
.........................................^...^.^.^.......^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.........................................
.............................................................................................................................................
........................................^.^.^.^.^.^.....^...^.....^.^.....^.^.^.^.^...^...^.^.^.^...^........................................
.............................................................................................................................................
.......................................^.^.^.^.^.^.^.^.^.^.^.^.^.^.......^.......^.^.....^...^.^...^.^.......................................
.............................................................................................................................................
......................................^.^.^.^.^.^.^...^.^...^.^.^...^...^.....^.^.......^.^.....^...^.^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.^.^...^...^.^.^.^...^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.....................................
.............................................................................................................................................
....................................^...^.^...^...^.^.....^.^...^.^.^.^.^...^.^.^.^.^...^.^.^.^...^.^.^.^....................................
.............................................................................................................................................
...................................^.^...^...^.^.....^.....^.....^...^.^.^.^.^...^.^.^.^...^...^.^.^.^...^...................................
.............................................................................................................................................
..................................^...^.^.^.^.....^...^.....^.^.^.........^.^.^.....^.^.^.^.^...^.^.^.^.^.^..................................
.............................................................................................................................................
.................................^.....^.^.^.......^.^.....^.^.^.^.......^.^.^...^.....^.......^.^...^.....^.................................
.............................................................................................................................................
................................^...^.^.^.^.^.^.^.^.....^...^.....^.^.^.....^.^...^.^.^.....^.^.......^.^.^.^................................
.............................................................................................................................................
...............................^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.........^.^.^.^.....^.^.^.^...^...^.^...............................
.............................................................................................................................................
..............................^...^.............^...^.^...^...^.^.....^.^.....^...^.^...^.^.^...^...^.^.^.^...^..............................
.............................................................................................................................................
.............................^...^...^...^...^.^.^.^.........^...^.....^.^.^.^.^.^.^.^.....^.......^.^...^...^.^.............................
.............................................................................................................................................
............................^.^.^.^.^.^.....^.^...^.^.............^.^.^.^.^.^...^.^.^...^.^...^...^.^.^...^...^.^............................
.............................................................................................................................................
...........................^...^...^...^.^.^.^.......^.^.^...^...^...^.^.^...^.^.^...^.^.......^.^.^.^.^.^.....^.^...........................
.............................................................................................................................................
..........................^.^.^.^.^.^.^.^...^.^...^.^...^.^.......^.^...^.^.^.^...^.^...^...^.^...^.^.^.^.^.^.^...^..........................
.............................................................................................................................................
.........................^.....^.^.....^.^...^...^.^.^...^.......^.^.^...^.^.....^.....^...^.^...^.....^...^.^.^.^.^.........................
.............................................................................................................................................
........................^.^.^.^.^.^.^.^.^.....^...^...^...^.^.^.^...^.......^.......^...^...^.^.^...^.^.....^...^.^.^........................
.............................................................................................................................................
.......................^.^...^.^.....^.^...^.....^.^.^.^.^.^.^...........^.......^.^.^.......^.^.^.^.^.^.....^.......^.......................
.............................................................................................................................................
......................^.....^...^.^...^.^.^...^.^.^...^.^...^.^.^...^.....^...^.....^.^.^.^.^.^...^.....^.^.^.^...^.^.^......................
.............................................................................................................................................
.....................^.^.^.^...^.^...^...^.^...^.^.^.^.^.^...^.^.^.^...^.^.......^.^...^.........^.^.^.^...^.....^.^.^.^.....................
.............................................................................................................................................
....................^.^.^.^.^.^...^...........^.^.^.^.^.......^.....^.^...^...^.^.^...^.^.^.^...^.^.^.^.^...^.....^.^...^....................
.............................................................................................................................................
...................^.^.....^.^.^.^.^.^.^.^.^.^.^.......^.....^.........^.^.^.^.^.^.^.^.^.....^.^.^...^.^.^...^.^...^.^.^.^...................
.............................................................................................................................................
..................^.......^.^...^.^...^.^.^.....^.^.^.^.....^.......^...^.^.....^.^.....^.^...^.^.^.^.^.....^.^.^.......^.^..................
.............................................................................................................................................
.................^...^.^.^.^.^.....^.^.^...^.^...^...^...^.^.^.^.^.^...^.....^.^.^...^.^.....^.^.^.^.^.^.^.^.^.....^.......^.................
.............................................................................................................................................
................^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^...^.^.^...^.^.^...^...^.^.....^...^.^.^.^...^.^.....^.^................
.............................................................................................................................................
...............^...^.^.^.^.^.^.^...^.^.....^...^.^.....^.^.....^.^.....^.^.^.^...^.^.^...^.^.....^.^.....^.....^.....^.^.^.^.^...............
.............................................................................................................................................
..............^.^.^...^.........^.^.^.^...^.......^.^.^.^.....^.^.^.^.....^.^.^.....^.^.^.........^.....^.^...^.^...^.^.^.^.^.^..............
.............................................................................................................................................
.............^.^.^.^...^...^.^...^...^.......^.^.^.....^.^.^.^...^...^.^.^.........^.....^.^.....^.......^.^.......^.^.^.^.^.^.^.............
.............................................................................................................................................
............^...^.^.^...............^.^.^.^...^.^.^.^.......^...^.^.^...^.^.^.^...^.^.^.^...^.^.....^.^.^...^.^.....^.^.^.^.^.^.^............
.............................................................................................................................................
...........^.^.^...^.^...^.^.^.^...^.^...^.^.^.....^...^.....^.^.^.^.^...^.^.^.^.....^.^...^.^...^.....^.^.^...^.^.......^...^.^.^...........
.............................................................................................................................................
..........^.^.^.^...^.^.^...^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.......^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^..........
.............................................................................................................................................
.........^.....^.^...^.^.....^.^.^...^.^.^...^.^.....^.^.^...^.^.^.^...^.^.^.^.^.^...^...^.^.^.^.^.^.^.....^.^...^.^.^.^...^.^.^...^.........
.............................................................................................................................................
........^...^.^.^.^.^.^.^.^.....^.^.^...^.^.........^.^.^.^.......^...^...^.^.^.^.^...^...^...^...^.......^...^.^.^.^.^...^.^.^.^.^.^........
.............................................................................................................................................
.......^.....^.^.^...^.^...^...^.....^...^.^.......^.....^.^.^.^.^.^.^.^.......^.^.^.^...^...^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.......
.............................................................................................................................................
......^.^.^.^.^.^...^.^.^.^.^.^.^...^...^.^.^.^.....^.^...^...^.^...^.^.^...^.....^.......^.^.^.....^...^.^.^...^...^.^...^.^...^.^...^......
.............................................................................................................................................
.....^...^.......^.^.^.^.^.^.^...^...^...^.^.^...^.^.^.^...^...^.^.^.....^.^.....^...^.....^.....^.^.^...^.^.^...^.^.^...^...^...^.^...^.....
.............................................................................................................................................
....^.^.^...^.^...^.^...^.^...^.^...^.^.^...^.....^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.^...^.^.^...^.^.^.^.^...^...^.^.^.....^....
.............................................................................................................................................
...^.^...^.^.^.^...^.^.^.^.^.^.^...........^.^.^.^...^...^.^.^...^.^.....^.^.^.^.....^...^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.......^...
.............................................................................................................................................
..^.^.^.^...^...^.^.^.....^.^.^.^.^...^.^.^.^...^...^.^.^.^...^...^.......^.^.^.^.^.^.^.^.^.^.^...^.^.^...^...^.^...^...^.^.^.^...^.^.^...^..
.............................................................................................................................................
.^.^.^.......^.....^.^.............^...^.....^.^.^.^.^.........^.^.^.........^.^.^.^.^.^.^...^...^.^...^.......^.^...^.^.^.^...^.^.^...^.^.^.
.............................................................................................................................................
"""

puzzle = """.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
...............
"""


print(puzzle)

rules = {
    ('S', '.'): '|',
    ('|', '^'): '|^|',
    ('|', '.'): '|',
}

lines = puzzle.splitlines()
new_state = lines.copy()
n_splits = 0
n_tachyons = 0

for l in range(len(lines)-1):
    for i in range(len(lines[l])):
        k1, k2 = lines[l][i], lines[l+1][i]
        if (k1, k2) in rules:
            replacement = rules[(k1, k2)]
            if len(replacement) == 1:
                new_state[l+1] = new_state[l+1][:i] + replacement + new_state[l+1][i+1:]
            elif len(replacement) == 3:
                new_state[l+1] = new_state[l+1][:i-1] + replacement + new_state[l+1][i+2:]
        if k1 == '|' and k2 == '^':
            n_splits += 1
        if k1 == '|':
            n_tachyons += 1
    lines = new_state.copy()
print('\n'.join(new_state))
print(n_splits)
print(n_tachyons)


# build adjacency matrix
import numpy as np

adj = np.zeros((n_tachyons, n_tachyons), dtype=bool)
node = 0
for i in range(len(new_state)-1):
    # find | in line i
    indices = [j for j, c in enumerate(new_state[i]) if c == '|']
    # find | in line i+1
    indices_next = [j for j, c in enumerate(new_state[i+1]) if c == '|']
    
    print(new_state[i])
    print(indices)
    print(new_state[i+1])
    print(indices_next)
    for idx in indices:
        for c, idx_next in enumerate(indices_next):
            if abs(idx - idx_next) <= 1:
                print(node, node + c)
                adj[node, node + c] = 1
                adj[node + c, node] = 1
        node += c

# walks = np.linalg.matrix_power(adj[:10, :10], 15)

# import matplotlib.pyplot as plt
# plt.imshow(adj[:10, :10])
# plt.show()
# plt.imshow(walks)
# plt.show()

    # for i in range(len(indices)-1):
    #     adj[indices[i], indices[i+1]] = True